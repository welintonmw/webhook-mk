import{G as B,r as T,e as b,b as le,ag as L,l as I,m as R,H as Q,p as m,M as P,O as C,S as N,T as k,u as V,R as x,U as S,I as p,a2 as ce,F as ue,a7 as we,az as de,aH as me,D as fe,w as pe,af as ve}from"./vendor-Dv5OeN6t.js";import{x as D,Q as X,l as Z,b as ke,j as ee,dh as ye,u as _e,e as he,V as U,dp as ge,e5 as be}from"./index-1OxaEeO3.js";import{d as We}from"./dateformat-CIxnBJXX.js";import{_ as K}from"./n8n-4UEsHtUL.js";import{W as $e}from"./WorkflowPreview-CVwpKdpj.js";import{d as He}from"./pinia-sugP77Im.js";import{F as Te}from"./file-saver-By8WREO3.js";import"./axios-Mm4CS0gO.js";import"./flatted-DN8lQ2XG.js";import"./@vueuse/core-BBHtM40w.js";import"./lodash-es-CZ1inz46.js";import"./@n8n/permissions-BxxteU-C.js";import"./vue-i18n-Delvyc9x.js";import"./uuid-SoommWqA.js";import"./luxon-CLwAIbs0.js";import"./@n8n/codemirror-lang-sql-DBO6T13I.js";import"./@lezer/common-B6ct0j_v.js";import"./prettier-bS6l4Vb1.js";import"./@jsplumb/util-DS-9vq_E.js";import"./@jsplumb/core-CVBraiyY.js";import"./@jsplumb/common-CF-b-6-M.js";import"./@jsplumb/connector-bezier-BGU0Ovbw.js";import"./@jsplumb/browser-ui-BVF2KoJK.js";import"./codemirror-lang-html-n8n-CWDO6_kP.js";import"./@n8n/codemirror-lang-Dl0FW_KM.js";import"./esprima-next-nhoSXAeq.js";import"./fast-json-stable-stringify-BOfzoJX1.js";import"./timeago.js-CiyKClrF.js";import"./qrcode.vue-BGkPba5A.js";import"./vue3-touch-events-mV0oX_Sl.js";import"./chart.js-343vZi4M.js";const Ie=["datetime"],Ve=["value"],Se=B({__name:"WorkflowHistoryListItem",props:{item:{},index:{},actions:{},isActive:{type:Boolean}},emits:["action","preview","mounted"],setup(W,{emit:_}){const t=W,s=_,f=D(),c=T(!1),v=T(null),w=T(null),u=T(!1),h=b(()=>{const e=new Date().getFullYear().toString(),[r,n]=We(t.item.createdAt,`${t.item.createdAt.startsWith(e)?"":"yyyy "}mmm d"#"HH:MM:ss`).split("#");return f.baseText("workflowHistory.item.createdAt",{interpolate:{date:r,time:n}})}),$=b(()=>{const e=t.item.authors.split(", ");let r=e[0];return e.length>1&&(r=`${r} + ${e.length-1}`),{size:e.length,label:r}}),O=b(()=>f.baseText("workflowHistory.item.id",{interpolate:{id:t.item.versionId}})),d=e=>{s("action",{action:e,id:t.item.versionId,data:{formattedCreatedAt:h.value}})},a=e=>{c.value=e},l=e=>{s("preview",{event:e,id:t.item.versionId})};return le(()=>{var e,r,n;s("mounted",{index:t.index,offsetTop:((e=v.value)==null?void 0:e.offsetTop)??0,isActive:t.isActive}),u.value=(((r=w.value)==null?void 0:r.scrollWidth)??0)>(((n=w.value)==null?void 0:n.clientWidth)??0)}),(e,r)=>{const n=L("n8n-tooltip"),y=L("n8n-badge"),H=L("n8n-action-toggle");return I(),R("li",{ref_key:"itemElement",ref:v,"data-test-id":"workflow-history-list-item",class:p({[e.$style.item]:!0,[e.$style.active]:t.isActive,[e.$style.actionsVisible]:c.value})},[Q(e.$slots,"default",{formattedCreatedAt:h.value},()=>[m("p",{onClick:l},[m("time",{datetime:e.item.createdAt},k(h.value),9,Ie),S(n,{placement:"right-end",disabled:$.value.size<2&&!u.value},{content:C(()=>[N(k(t.item.authors),1)]),default:C(()=>[m("span",{ref_key:"authorElement",ref:w},k($.value.label),513)]),_:1},8,["disabled"]),m("data",{value:e.item.versionId},k(O.value),9,Ve)])]),m("div",{class:p(e.$style.tail)},[t.index===0?(I(),P(y,{key:0},{default:C(()=>[N(k(V(f).baseText("workflowHistory.item.latest")),1)]),_:1})):x("",!0),S(H,{theme:"dark",class:p(e.$style.actions),actions:t.actions,placement:"bottom-end",onAction:d,onClick:r[0]||(r[0]=ce(()=>{},["stop"])),onVisibleChange:a},{default:C(()=>[Q(e.$slots,"action-toggle-button")]),_:3},8,["class","actions"])],2)],2)}}}),Ce="_item_1a4du_1",Oe="_tail_1a4du_33",Ae="_active_1a4du_38",Le="_actionsVisible_1a4du_45",Re="_actions_1a4du_45",xe={item:Ce,tail:Oe,active:Ae,actionsVisible:Le,actions:Re},Me={$style:xe},te=K(Se,[["__cssModules",Me]]),Ee=m("br",null,null,-1),Ne=["aria-label"],Pe=B({__name:"WorkflowHistoryList",props:{items:{},activeItem:{},actions:{},requestNumberOfItems:{},lastReceivedItemsLength:{},evaluatedPruneTime:{},shouldUpgrade:{type:Boolean},isListLoading:{type:Boolean}},emits:["action","preview","loadMore","upgrade"],setup(W,{emit:_}){const t=W,s=_,f=D(),c=T(null),v=T(!0),w=T(null),u=a=>a===0?t.actions.filter(l=>l.value!=="restore"):t.actions,h=a=>{w.value=new IntersectionObserver(([l])=>{var e,r;l.isIntersecting&&((e=w.value)==null||e.unobserve(a),(r=w.value)==null||r.disconnect(),w.value=null,s("loadMore",{take:t.requestNumberOfItems,skip:t.items.length}))},{root:c.value,threshold:.01}),w.value.observe(a)},$=({action:a,id:l,data:e})=>{v.value=!1,s("action",{action:a,id:l,data:e})},O=({event:a,id:l})=>{v.value=!1,s("preview",{event:a,id:l})},d=({index:a,offsetTop:l,isActive:e})=>{var r,n;e&&v.value&&(v.value=!1,(r=c.value)==null||r.scrollTo({top:l,behavior:"smooth"})),a===t.items.length-1&&t.lastReceivedItemsLength===t.requestNumberOfItems&&h((n=c.value)==null?void 0:n.children[a])};return(a,l)=>{const e=L("n8n-loading"),r=L("i18n-t");return I(),R("ul",{ref_key:"listElement",ref:c,class:p(a.$style.list),"data-test-id":"workflow-history-list"},[(I(!0),R(ue,null,we(t.items,(n,y)=>{var H;return I(),P(te,{key:n.versionId,index:y,item:n,"is-active":n.versionId===((H=t.activeItem)==null?void 0:H.versionId),actions:u(y),onAction:$,onPreview:O,onMounted:d},null,8,["index","item","is-active","actions"])}),128)),!t.items.length&&!t.isListLoading?(I(),R("li",{key:0,class:p(a.$style.empty)},[N(k(V(f).baseText("workflowHistory.empty"))+" ",1),Ee,N(" "+k(V(f).baseText("workflowHistory.hint")),1)],2)):x("",!0),t.isListLoading?(I(),R("li",{key:1,class:p(a.$style.loader),role:"status","aria-live":"polite","aria-busy":"true","aria-label":V(f).baseText("generic.loading")},[S(e,{rows:3,class:"mb-xs"}),S(e,{rows:3,class:"mb-xs"}),S(e,{rows:3,class:"mb-xs"})],10,Ne)):x("",!0),t.shouldUpgrade?(I(),R("li",{key:2,class:p(a.$style.retention)},[m("span",null,k(V(f).baseText("workflowHistory.limit",{interpolate:{evaluatedPruneTime:String(t.evaluatedPruneTime)}})),1),S(r,{keypath:"workflowHistory.upgrade",tag:"span"},{link:C(()=>[m("a",{href:"#",onClick:l[0]||(l[0]=n=>s("upgrade"))},k(V(f).baseText("workflowHistory.upgrade.link")),1)]),_:1})],2)):x("",!0)],2)}}}),Ue="_list_undzg_1",Fe="_empty_undzg_10",ze="_loader_undzg_23",Be="_retention_undzg_27",De={list:Ue,empty:Fe,loader:ze,retention:Be},Ke={$style:De},qe=K(Pe,[["__cssModules",Ke]]),Ye=["datetime"],je=["value"],Ge=B({__name:"WorkflowHistoryContent",props:{workflow:{},workflowVersion:{},actions:{},isListLoading:{type:Boolean},isFirstItemShown:{type:Boolean}},emits:["action"],setup(W,{emit:_}){const t=D(),s=W,f=_,c=b(()=>{if(!s.workflowVersion||!s.workflow)return;const{pinData:u,...h}=s.workflow;return{...h,nodes:s.workflowVersion.nodes,connections:s.workflowVersion.connections}}),v=b(()=>s.isFirstItemShown?s.actions.filter(u=>u.value!=="restore"):s.actions),w=({action:u,id:h,data:$})=>{f("action",{action:u,id:h,data:$})};return(u,h)=>{const $=L("n8n-icon"),O=L("n8n-button");return I(),R("div",{class:p(u.$style.content)},[s.workflowVersion?(I(),P($e,{key:0,workflow:c.value,loading:s.isListLoading,"loader-type":"spinner"},null,8,["workflow","loading"])):x("",!0),m("ul",{class:p(u.$style.info)},[s.workflowVersion?(I(),P(te,{key:0,class:p(u.$style.card),index:-1,item:s.workflowVersion,"is-active":!1,actions:v.value,onAction:w},{default:C(({formattedCreatedAt:d})=>[m("section",{class:p(u.$style.text)},[m("p",null,[m("span",{class:p(u.$style.label)},k(V(t).baseText("workflowHistory.content.title"))+": ",3),m("time",{datetime:s.workflowVersion.createdAt},k(d),9,Ye)]),m("p",null,[m("span",{class:p(u.$style.label)},k(V(t).baseText("workflowHistory.content.editedBy"))+": ",3),m("span",null,k(s.workflowVersion.authors),1)]),m("p",null,[m("span",{class:p(u.$style.label)},k(V(t).baseText("workflowHistory.content.versionId"))+": ",3),m("data",{value:s.workflowVersion.versionId},k(s.workflowVersion.versionId),9,je)])],2)]),"action-toggle-button":C(()=>[S(O,{type:"tertiary",size:"large","data-test-id":"action-toggle-button"},{default:C(()=>[N(k(V(t).baseText("workflowHistory.content.actions"))+" ",1),S($,{class:"ml-3xs",icon:"chevron-down",size:"small"})]),_:1})]),_:1},8,["class","item","actions"])):x("",!0)],2)],2)}}}),Je="_content_2kwc4_1",Qe="_info_2kwc4_11",Xe="_card_2kwc4_19",Ze="_text_2kwc4_24",et="_label_2kwc4_49",tt={content:Je,info:Qe,card:Xe,text:Ze,label:et},ot={$style:tt},st=K(Ge,[["__cssModules",ot]]),nt=async(W,_,t)=>{const{data:s}=await X(W.baseUrl,`/workflow-history/workflow/${_}`,t);return s},at=async(W,_,t)=>{const{data:s}=await X(W.baseUrl,`/workflow-history/workflow/${_}/version/${t}`);return s},rt=He("workflowHistory",()=>{const W=Z(),_=ke(),t=ee(),s=b(()=>_.settings.workflowHistory.licensePruneTime),f=b(()=>_.settings.workflowHistory.pruneTime),c=b(()=>Math.min(f.value,s.value)),v=b(()=>s.value!==-1&&s.value===f.value),w=async(d,a)=>await nt(W.restApiContext,d,a),u=async(d,a)=>await at(W.restApiContext,d,a);return{getWorkflowHistory:w,getWorkflowVersion:u,downloadVersion:async(d,a,l)=>{const[e,r]=await Promise.all([t.fetchWorkflow(d),u(d,a)]),{connections:n,nodes:y}=r,H=new Blob([JSON.stringify({...e,nodes:y,connections:n},null,2)],{type:"application/json;charset=utf-8"});Te.saveAs(H,`${e.name}(${l.formattedCreatedAt}).json`)},cloneIntoNewWorkflow:async(d,a,l)=>{const[e,r]=await Promise.all([t.fetchWorkflow(d),u(d,a)]),{connections:n,nodes:y}=r,{name:H}=e,F=await ye(W.restApiContext,{name:`${H} (${l.formattedCreatedAt})`}),q={nodes:y,connections:n,name:F.name};return await t.createNewWorkflow(q)},restoreWorkflow:async(d,a,l)=>{const e=await u(d,a),{connections:r,nodes:n}=e,y={connections:r,nodes:n};return l&&(y.active=!1),await t.updateWorkflow(d,y,!0).catch(async H=>{if(H.httpStatusCode===400&&H.message.includes("can not be activated"))return await t.fetchWorkflow(d);throw new Error(H)})},evaluatedPruneTime:c,shouldUpgrade:v}}),it=B({__name:"WorkflowHistory",setup(W){const _=["restore","clone","open","download"],t=_.reduce((o,i)=>({...o,[i.toUpperCase()]:i}),{}),s=de(),f=me(),c=D(),v=_e(),w=rt(),u=he(),h=ee(),$=T(!0),O=T(!0),d=T(20),a=T(0),l=T(null),e=T([]),r=T(null),n=b(()=>j("workflowId")),y=b(()=>j("versionId")),H=b(()=>({name:U.WORKFLOW,params:{name:n.value}})),F=b(()=>_.map(o=>({label:c.baseText(`workflowHistory.item.actions.${o}`),disabled:!1,value:o}))),q=b(()=>{var o;return((o=e.value[0])==null?void 0:o.versionId)===y.value}),oe=b(()=>Math.floor(w.evaluatedPruneTime/24)),M=o=>{ge.track(o,{instance_id:Z().instanceId,workflow_id:n.value})},Y=async o=>{const i=await w.getWorkflowHistory(n.value,o);a.value=i.length,e.value=e.value.concat(i)};fe(async()=>{M("User opened workflow history");try{const[o]=await Promise.all([h.fetchWorkflow(n.value),Y({take:d.value})]);l.value=o,O.value=!1,!y.value&&e.value.length&&await f.replace({name:U.WORKFLOW_HISTORY,params:{workflowId:n.value,versionId:e.value[0].versionId}})}catch(o){$.value=!1,v.showError(o,c.baseText("workflowHistory.title"))}});const j=o=>{const i=s.params[o];return typeof i=="string"?i:(i==null?void 0:i[0])??""},G=o=>{const{href:i}=f.resolve({name:U.WORKFLOW_HISTORY,params:{workflowId:n.value,versionId:o}});window.open(i,"_blank")},se=async(o,i)=>await new Promise((g,A)=>{const E=[{text:c.baseText("workflowHistory.action.restore.modal.button.cancel"),type:"tertiary",action:()=>{g("cancel")}}];o&&E.push({text:c.baseText("workflowHistory.action.restore.modal.button.deactivateAndRestore"),type:"tertiary",action:()=>{g("deactivateAndRestore")}}),E.push({text:c.baseText("workflowHistory.action.restore.modal.button.restore"),type:"primary",action:()=>{g("restore")}});try{u.openModalWithData({name:be,data:{beforeClose:()=>{g("cancel")},isWorkflowActivated:o,formattedCreatedAt:i,buttons:E}})}catch(z){A(z)}}),ne=async(o,i)=>{const g=await w.cloneIntoNewWorkflow(n.value,o,i),{href:A}=f.resolve({name:U.WORKFLOW,params:{name:g.id}});v.showMessage({title:c.baseText("workflowHistory.action.clone.success.title"),message:ve("a",{href:A,target:"_blank"},c.baseText("workflowHistory.action.clone.success.message")),type:"success",duration:1e4})},ae=async(o,i)=>{const g=await h.fetchWorkflow(n.value),A=await se(g.active,i.formattedCreatedAt);if(A==="cancel")return;l.value=await w.restoreWorkflow(n.value,o,A==="deactivateAndRestore");const E=await w.getWorkflowHistory(n.value,{take:1});e.value=E.concat(e.value),v.showMessage({title:c.baseText("workflowHistory.action.restore.success.title"),type:"success"})},J=async({action:o,id:i,data:g})=>{try{switch(o){case t.OPEN:G(i),M("User opened version in new tab");break;case t.DOWNLOAD:await w.downloadVersion(n.value,i,g),M("User downloaded version");break;case t.CLONE:await ne(i,g),M("User cloned version");break;case t.RESTORE:await ae(i,g),M("User restored version");break}}catch(A){v.showError(A,c.baseText("workflowHistory.action.error.title",{interpolate:{action:c.baseText(`workflowHistory.item.actions.${o}`).toLowerCase()}}))}},re=async({event:o,id:i})=>{o.metaKey||o.ctrlKey?(G(i),M("User opened version in new tab")):await f.push({name:U.WORKFLOW_HISTORY,params:{workflowId:n.value,versionId:i}})},ie=()=>{u.goToUpgrade("workflow-history","upgrade-workflow-history")};return pe(async()=>{if(y.value){try{r.value=await w.getWorkflowVersion(n.value,y.value),M("User selected version")}catch(o){v.showError(new Error(`${o.message} "${y.value}"&nbsp;`),c.baseText("workflowHistory.title"))}try{l.value=await h.fetchWorkflow(n.value)}catch(o){$.value=!1,v.showError(o,c.baseText("workflowHistory.title"))}}}),(o,i)=>{const g=L("n8n-heading"),A=L("n8n-button"),E=L("router-link");return I(),R("div",{class:p(o.$style.view)},[S(g,{class:p(o.$style.header),tag:"h2",size:"medium"},{default:C(()=>{var z;return[N(k((z=l.value)==null?void 0:z.name),1)]}),_:1},8,["class"]),m("div",{class:p(o.$style.corner)},[S(g,{tag:"h2",size:"medium",bold:""},{default:C(()=>[N(k(V(c).baseText("workflowHistory.title")),1)]),_:1}),S(E,{to:H.value,"data-test-id":"workflow-history-close-button"},{default:C(()=>[S(A,{type:"tertiary",icon:"times",size:"small",text:"",square:""})]),_:1},8,["to"])],2),m("div",{class:p(o.$style.listComponentWrapper)},[$.value?(I(),P(qe,{key:0,items:e.value,"last-received-items-length":a.value,"active-item":r.value,actions:F.value,"request-number-of-items":d.value,"should-upgrade":V(w).shouldUpgrade,"evaluated-prune-time":oe.value,"is-list-loading":O.value,onAction:J,onPreview:re,onLoadMore:Y,onUpgrade:ie},null,8,["items","last-received-items-length","active-item","actions","request-number-of-items","should-upgrade","evaluated-prune-time","is-list-loading"])):x("",!0)],2),m("div",{class:p(o.$style.contentComponentWrapper)},[$.value?(I(),P(st,{key:0,workflow:l.value,"workflow-version":r.value,actions:F.value,"is-list-loading":O.value,"is-first-item-shown":q.value,onAction:J},null,8,["workflow","workflow-version","actions","is-list-loading","is-first-item-shown"])):x("",!0)],2)],2)}}}),lt="_view_phdlt_1",ct="_header_phdlt_11",ut="_corner_phdlt_19",wt="_contentComponentWrapper_phdlt_30",dt="_listComponentWrapper_phdlt_35",mt={view:lt,header:ct,corner:ut,contentComponentWrapper:wt,listComponentWrapper:dt},ft={$style:mt},qt=K(it,[["__cssModules",ft]]);export{qt as default};
//# sourceMappingURL=WorkflowHistory-C6zCGFoY.js.map
