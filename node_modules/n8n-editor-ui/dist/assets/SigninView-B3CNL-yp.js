import{L as H,A as W}from"./AuthView-B_jZMnGj.js";import{x as q,d4 as y,d5 as Q,M as N,d6 as B,u as Y,U as K,e as X,b as J,a as Z,V as ee,d7 as te}from"./index-1OxaEeO3.js";import{h as oe}from"./@vueuse/core-BBHtM40w.js";import{G as L,r as m,b as re,ag as l,l as n,m as F,p as f,U as b,I as p,O as T,S as R,T as v,u as a,M as k,R as h}from"./vendor-Dv5OeN6t.js";import{_ as D}from"./n8n-4UEsHtUL.js";import{m as ae}from"./pinia-sugP77Im.js";import"./axios-Mm4CS0gO.js";import"./flatted-DN8lQ2XG.js";import"./lodash-es-CZ1inz46.js";import"./@n8n/permissions-BxxteU-C.js";import"./dateformat-CIxnBJXX.js";import"./vue-i18n-Delvyc9x.js";import"./uuid-SoommWqA.js";import"./luxon-CLwAIbs0.js";import"./@n8n/codemirror-lang-sql-DBO6T13I.js";import"./@lezer/common-B6ct0j_v.js";import"./prettier-bS6l4Vb1.js";import"./@jsplumb/util-DS-9vq_E.js";import"./@jsplumb/core-CVBraiyY.js";import"./@jsplumb/common-CF-b-6-M.js";import"./@jsplumb/connector-bezier-BGU0Ovbw.js";import"./@jsplumb/browser-ui-BVF2KoJK.js";import"./codemirror-lang-html-n8n-CWDO6_kP.js";import"./@n8n/codemirror-lang-Dl0FW_KM.js";import"./esprima-next-nhoSXAeq.js";import"./fast-json-stable-stringify-BOfzoJX1.js";import"./timeago.js-CiyKClrF.js";import"./qrcode.vue-BGkPba5A.js";import"./vue3-touch-events-mV0oX_Sl.js";import"./chart.js-343vZi4M.js";const se=L({__name:"MfaView",props:{reportError:{}},emits:["onFormChanged","onBackClick","submit"],setup(e,{emit:t}){const i=e,c=m(!1),M=m(Q),u=m(null),s=m(!1),_=m(!1),S=m(""),{reportError:O}=oe(i),r=q(),w=t,A=(o,E,d,C,g=!0)=>({name:o,initialValue:"",properties:{label:E,placeholder:d,maxlength:C,capitalize:!0,validateOnBlur:!1,focusInitially:g}}),V=()=>{S.value="",s.value=!0,c.value=!1,u.value=[z()],w("onFormChanged",y.MFA_RECOVERY_CODE)},U=()=>{if(!s.value){w("onBackClick",y.MFA_TOKEN);return}s.value=!1,c.value=!0,u.value=[I()],w("onBackClick",y.MFA_RECOVERY_CODE)},$=async o=>{S.value=s.value?r.baseText("mfa.recovery.invalid"):r.baseText("mfa.code.invalid"),w("submit",o)},P=({target:{value:o,name:E}})=>{const d=E==="token",C=d?N:B;if(o.length!==C){c.value=!1;return}_.value=!0,c.value=!0,$(d?{token:o,recoveryCode:""}:{token:"",recoveryCode:o}).catch(()=>{}).finally(()=>_.value=!1)},z=()=>A("recoveryCode",r.baseText("mfa.recovery.input.label"),r.baseText("mfa.recovery.input.placeholder"),B),I=()=>A("token",r.baseText("mfa.code.input.label"),r.baseText("mfa.code.input.placeholder"),N),j=()=>{M.value.emit("submit")};return re(()=>{u.value=[I()]}),(o,E)=>{const d=l("n8n-heading"),C=l("n8n-form-inputs"),g=l("n8n-text"),x=l("n8n-button"),G=l("n8n-card");return n(),F("div",{class:p(o.$style.container)},[f("div",{class:p(o.$style.logoContainer)},[b(H)],2),b(G,null,{default:T(()=>[f("div",{class:p(o.$style.headerContainer)},[b(d,{size:"xlarge",color:"text-dark"},{default:T(()=>[R(v(s.value?a(r).baseText("mfa.recovery.modal.title"):a(r).baseText("mfa.code.modal.title")),1)]),_:1})],2),f("div",{class:p([o.$style.formContainer,a(O)?o.$style.formError:""])},[u.value?(n(),k(C,{key:0,"data-test-id":"mfa-login-form",inputs:u.value,"event-bus":M.value,onInput:P,onSubmit:$},null,8,["inputs","event-bus"])):h("",!0),f("div",{class:p(o.$style.infoBox)},[!s.value&&!a(O)?(n(),k(g,{key:0,size:"small",color:"text-base",bold:!1},{default:T(()=>[R(v(a(r).baseText("mfa.code.input.info"))+" ",1),f("a",{"data-test-id":"mfa-enter-recovery-code-button",onClick:V},v(a(r).baseText("mfa.code.input.info.action")),1)]),_:1})):h("",!0),a(O)?(n(),k(g,{key:1,color:"danger",size:"small"},{default:T(()=>[R(v(S.value)+" ",1),s.value?h("",!0):(n(),F("a",{key:0,class:p(o.$style.recoveryCodeLink),onClick:V},v(a(r).baseText("mfa.recovery.input.info.action")),3))]),_:1})):h("",!0)],2)],2),f("div",null,[b(x,{float:"right",loading:_.value,label:s.value?a(r).baseText("mfa.recovery.button.verify"):a(r).baseText("mfa.code.button.continue"),size:"large",disabled:!c.value,onClick:j},null,8,["loading","label","disabled"]),b(x,{float:"left",label:a(r).baseText("mfa.button.back"),size:"large",type:"tertiary",onClick:U},null,8,["label"])])]),_:1})],2)}}}),ie="_container_1mdjt_5",ne="_logoContainer_1mdjt_16",le="_formContainer_1mdjt_21",ce="_headerContainer_1mdjt_25",ue="_formError_1mdjt_30",de="_recoveryCodeLink_1mdjt_34",me="_infoBox_1mdjt_38",fe={container:ie,logoContainer:ne,formContainer:le,headerContainer:ce,formError:ue,recoveryCodeLink:de,infoBox:me},pe={$style:fe},he=D(se,[["__cssModules",pe]]),_e=L({name:"SigninView",components:{AuthView:W,MfaView:he},setup(){return{...Y()}},data(){return{FORM_CONFIG:{},loading:!1,showMfaView:!1,email:"",password:"",reportError:!1}},computed:{...ae(Z,J,X,K),userHasMfaEnabled(){var e;return!!((e=this.usersStore.currentUser)!=null&&e.mfaEnabled)}},mounted(){let e=this.$locale.baseText("auth.email");const t=this.settingsStore.ldapLoginLabel,i=this.settingsStore.isLdapLoginEnabled;i&&t&&(e=t),this.FORM_CONFIG={title:this.$locale.baseText("auth.signin"),buttonText:this.$locale.baseText("auth.signin"),redirectText:this.$locale.baseText("forgotPassword"),inputs:[{name:"email",properties:{label:e,type:"email",required:!0,...!i&&{validationRules:[{name:"VALID_EMAIL"}]},showRequiredAsterisk:!1,validateOnBlur:!1,autocomplete:"email",capitalize:!0}},{name:"password",properties:{label:this.$locale.baseText("auth.password"),type:"password",required:!0,showRequiredAsterisk:!1,validateOnBlur:!1,autocomplete:"current-password",capitalize:!0}}]},this.settingsStore.isDesktopDeployment||(this.FORM_CONFIG.redirectLink="/forgot-password")},methods:{async onMFASubmitted(e){await this.login({email:this.email,password:this.password,token:e.token,recoveryCode:e.recoveryCode})},async onEmailPasswordSubmitted(e){await this.login(e)},isRedirectSafe(){const e=this.getRedirectQueryParameter();return e.startsWith("/")||e.startsWith(window.location.origin)},getRedirectQueryParameter(){var t,i;let e="";return typeof((t=this.$route.query)==null?void 0:t.redirect)=="string"&&(e=decodeURIComponent((i=this.$route.query)==null?void 0:i.redirect)),e},async login(e){try{if(this.loading=!0,await this.usersStore.loginWithCreds({email:e.email,password:e.password,mfaToken:e.token,mfaRecoveryCode:e.recoveryCode}),this.loading=!1,this.settingsStore.isCloudDeployment)try{await this.cloudPlanStore.checkForCloudPlanData()}catch(t){console.warn("Failed to check for cloud plan data",t)}if(await this.settingsStore.getSettings(),this.clearAllStickyNotifications(),this.$telemetry.track("User attempted to login",{result:this.showMfaView?"mfa_success":"success"}),this.isRedirectSafe()){const t=this.getRedirectQueryParameter();if(t.startsWith("http")){window.location.href=t;return}this.$router.push(t);return}await this.$router.push({name:ee.HOMEPAGE})}catch(t){if(t.errorCode===te){this.showMfaView=!0,this.cacheCredentials(e);return}if(this.$telemetry.track("User attempted to login",{result:this.showMfaView?"mfa_token_rejected":"credentials_error"}),!this.showMfaView){this.showError(t,this.$locale.baseText("auth.signin.error")),this.loading=!1;return}this.reportError=!0}},onBackClick(e){this.reportError=!1,e===y.MFA_TOKEN&&(this.showMfaView=!1,this.loading=!1)},onFormChanged(e){e===y.MFA_RECOVERY_CODE&&(this.reportError=!1)},cacheCredentials(e){this.email=e.email,this.password=e.password}}});function Ce(e,t,i,c,M,u){const s=l("AuthView"),_=l("MfaView");return n(),F("div",null,[e.showMfaView?h("",!0):(n(),k(s,{key:0,form:e.FORM_CONFIG,"form-loading":e.loading,"with-sso":!0,"data-test-id":"signin-form",onSubmit:e.onEmailPasswordSubmitted},null,8,["form","form-loading","onSubmit"])),e.showMfaView?(n(),k(_,{key:1,"report-error":e.reportError,onSubmit:e.onMFASubmitted,onOnBackClick:e.onBackClick,onOnFormChanged:e.onFormChanged},null,8,["report-error","onSubmit","onOnBackClick","onOnFormChanged"])):h("",!0)])}const Qe=D(_e,[["render",Ce]]);export{Qe as default};
//# sourceMappingURL=SigninView-B3CNL-yp.js.map
