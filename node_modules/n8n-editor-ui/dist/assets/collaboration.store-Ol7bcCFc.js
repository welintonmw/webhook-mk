import{d as C}from"./pinia-sugP77Im.js";import{R as g,l as T,b as $,T as b,j as I}from"./index-1OxaEeO3.js";import{e as L,r as s}from"./vendor-Dv5OeN6t.js";const A=C(g.PUSH,()=>{const r=T(),p=$(),u=L(()=>r.pushRef),e=s(null),l=s(null),f=s(0),w=s(!1),c=s([]),i=s(!1),a=s([]),n=t=>(a.value.push(t),()=>{const o=a.value.indexOf(t);o!==-1&&a.value.splice(o,1)});function v(){h(),f.value++,l.value=setTimeout(R,Math.min(f.value*2e3,8*b.SECOND))}function h(){e.value!==null&&(e.value.removeEventListener("error",v),e.value.removeEventListener("close",v),e.value.removeEventListener("message",E),e.value.readyState<2&&e.value.close(),e.value=null),i.value=!1}function S(){h(),l.value&&(clearTimeout(l.value),l.value=null);const t=p.pushBackend==="websocket",o=r.restUrl,d=`/push?pushRef=${u.value}`;if(t){const{protocol:y,host:W}=window.location,U=o.startsWith("http")?o.replace(/^http/,"ws"):`${y==="https:"?"wss":"ws"}://${W+o}`;e.value=new WebSocket(`${U}${d}`)}else e.value=new EventSource(`${o}${d}`,{withCredentials:!0});e.value.addEventListener("open",k,!1),e.value.addEventListener("message",E,!1),e.value.addEventListener(t?"close":"error",v,!1)}function R(){S()}function m(t){e.value&&"send"in e.value&&e.value.send(JSON.stringify(t))}function k(){var t;if(i.value=!0,f.value=0,w.value=!1,r.setPushConnectionActive(),(t=e.value)==null||t.removeEventListener("open",k),c.value.length){for(const o of c.value)m(o);c.value=[]}}function O(t){if(!i.value){c.value.push(t);return}m(t)}async function E(t){let o;try{o=JSON.parse(t.data)}catch{return}a.value.forEach(d=>d(o))}return{pushRef:u,pushSource:e,isConnectionOpen:i,onMessageReceivedHandlers:a,addEventListener:n,pushConnect:S,pushDisconnect:h,send:O}}),D=C(g.COLLABORATION,()=>{const r=A(),p=I(),u=s({}),e=s(null),l=L(()=>u.value[p.workflowId]??[]);function f(){e.value=r.addEventListener(n=>{if(n.type==="activeWorkflowUsersChanged"){const v=p.workflowId;n.data.workflowId===v&&(u.value[v]=n.data.activeUsers)}})}function w(){typeof e.value=="function"&&e.value()}function c(n){u.value=n}function i(n){r.send({type:"workflowOpened",workflowId:n})}function a(n){r.send({type:"workflowClosed",workflowId:n})}return{usersForWorkflows:u,initialize:f,terminate:w,notifyWorkflowOpened:i,notifyWorkflowClosed:a,workflowUsersUpdated:c,getUsersForCurrentWorkflow:l}});export{A as a,D as u};
//# sourceMappingURL=collaboration.store-Ol7bcCFc.js.map
