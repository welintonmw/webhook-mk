{"version":3,"file":"collaboration.store-Ol7bcCFc.js","sources":["../../src/stores/pushConnection.store.ts","../../src/stores/collaboration.store.ts"],"sourcesContent":["import { defineStore } from 'pinia';\nimport { STORES, TIME } from '@/constants';\nimport { ref, computed } from 'vue';\nimport { useSettingsStore } from './settings.store';\nimport { useRootStore } from './root.store';\nimport type { IPushData } from '../Interface';\n\nexport interface PushState {\n\tpushRef: string;\n\tpushSource: WebSocket | EventSource | null;\n\treconnectTimeout: NodeJS.Timeout | null;\n\tretryTimeout: NodeJS.Timeout | null;\n\tpushMessageQueue: Array<{ event: Event; retriesLeft: number }>;\n\tconnectRetries: number;\n\tlostConnection: boolean;\n\toutgoingQueue: unknown[];\n\tisConnectionOpen: boolean;\n}\n\nexport type OnPushMessageHandler = (event: IPushData) => void;\n\n/**\n * Store for managing a push connection to the server\n */\nexport const usePushConnectionStore = defineStore(STORES.PUSH, () => {\n\tconst rootStore = useRootStore();\n\tconst settingsStore = useSettingsStore();\n\n\tconst pushRef = computed(() => rootStore.pushRef);\n\tconst pushSource = ref<WebSocket | EventSource | null>(null);\n\tconst reconnectTimeout = ref<NodeJS.Timeout | null>(null);\n\tconst connectRetries = ref(0);\n\tconst lostConnection = ref(false);\n\tconst outgoingQueue = ref<unknown[]>([]);\n\tconst isConnectionOpen = ref(false);\n\n\tconst onMessageReceivedHandlers = ref<OnPushMessageHandler[]>([]);\n\n\tconst addEventListener = (handler: OnPushMessageHandler) => {\n\t\tonMessageReceivedHandlers.value.push(handler);\n\t\treturn () => {\n\t\t\tconst index = onMessageReceivedHandlers.value.indexOf(handler);\n\t\t\tif (index !== -1) {\n\t\t\t\tonMessageReceivedHandlers.value.splice(index, 1);\n\t\t\t}\n\t\t};\n\t};\n\n\tfunction onConnectionError() {\n\t\tpushDisconnect();\n\t\tconnectRetries.value++;\n\t\treconnectTimeout.value = setTimeout(\n\t\t\tattemptReconnect,\n\t\t\tMath.min(connectRetries.value * 2000, 8 * TIME.SECOND), // maximum 8 seconds backoff\n\t\t);\n\t}\n\n\t/**\n\t * Close connection to server\n\t */\n\tfunction pushDisconnect() {\n\t\tif (pushSource.value !== null) {\n\t\t\tpushSource.value.removeEventListener('error', onConnectionError);\n\t\t\tpushSource.value.removeEventListener('close', onConnectionError);\n\t\t\tpushSource.value.removeEventListener('message', pushMessageReceived);\n\t\t\tif (pushSource.value.readyState < 2) pushSource.value.close();\n\t\t\tpushSource.value = null;\n\t\t}\n\n\t\tisConnectionOpen.value = false;\n\t}\n\n\t/**\n\t * Connect to server to receive data via a WebSocket or EventSource\n\t */\n\tfunction pushConnect() {\n\t\t// always close the previous connection so that we do not end up with multiple connections\n\t\tpushDisconnect();\n\n\t\tif (reconnectTimeout.value) {\n\t\t\tclearTimeout(reconnectTimeout.value);\n\t\t\treconnectTimeout.value = null;\n\t\t}\n\n\t\tconst useWebSockets = settingsStore.pushBackend === 'websocket';\n\n\t\tconst restUrl = rootStore.restUrl;\n\t\tconst url = `/push?pushRef=${pushRef.value}`;\n\n\t\tif (useWebSockets) {\n\t\t\tconst { protocol, host } = window.location;\n\t\t\tconst baseUrl = restUrl.startsWith('http')\n\t\t\t\t? restUrl.replace(/^http/, 'ws')\n\t\t\t\t: `${protocol === 'https:' ? 'wss' : 'ws'}://${host + restUrl}`;\n\t\t\tpushSource.value = new WebSocket(`${baseUrl}${url}`);\n\t\t} else {\n\t\t\tpushSource.value = new EventSource(`${restUrl}${url}`, { withCredentials: true });\n\t\t}\n\n\t\tpushSource.value.addEventListener('open', onConnectionSuccess, false);\n\t\tpushSource.value.addEventListener('message', pushMessageReceived, false);\n\t\tpushSource.value.addEventListener(useWebSockets ? 'close' : 'error', onConnectionError, false);\n\t}\n\n\tfunction attemptReconnect() {\n\t\tpushConnect();\n\t}\n\n\tfunction serializeAndSend(message: unknown) {\n\t\tif (pushSource.value && 'send' in pushSource.value) {\n\t\t\tpushSource.value.send(JSON.stringify(message));\n\t\t}\n\t}\n\n\tfunction onConnectionSuccess() {\n\t\tisConnectionOpen.value = true;\n\t\tconnectRetries.value = 0;\n\t\tlostConnection.value = false;\n\t\trootStore.setPushConnectionActive();\n\t\tpushSource.value?.removeEventListener('open', onConnectionSuccess);\n\n\t\tif (outgoingQueue.value.length) {\n\t\t\tfor (const message of outgoingQueue.value) {\n\t\t\t\tserializeAndSend(message);\n\t\t\t}\n\t\t\toutgoingQueue.value = [];\n\t\t}\n\t}\n\n\tfunction send(message: unknown) {\n\t\tif (!isConnectionOpen.value) {\n\t\t\toutgoingQueue.value.push(message);\n\t\t\treturn;\n\t\t}\n\t\tserializeAndSend(message);\n\t}\n\n\t/**\n\t * Process a newly received message\n\t */\n\tasync function pushMessageReceived(event: Event) {\n\t\tlet receivedData: IPushData;\n\t\ttry {\n\t\t\t// @ts-ignore\n\t\t\treceivedData = JSON.parse(event.data);\n\t\t} catch (error) {\n\t\t\treturn;\n\t\t}\n\n\t\tonMessageReceivedHandlers.value.forEach((handler) => handler(receivedData));\n\t}\n\n\treturn {\n\t\tpushRef,\n\t\tpushSource,\n\t\tisConnectionOpen,\n\t\tonMessageReceivedHandlers,\n\t\taddEventListener,\n\t\tpushConnect,\n\t\tpushDisconnect,\n\t\tsend,\n\t};\n});\n","import { defineStore } from 'pinia';\nimport { computed, ref } from 'vue';\nimport { useWorkflowsStore } from '@/stores/workflows.store';\nimport { usePushConnectionStore } from '@/stores/pushConnection.store';\nimport { STORES } from '@/constants';\nimport type { IUser } from '@/Interface';\n\ntype ActiveUsersForWorkflows = {\n\t[workflowId: string]: Array<{ user: IUser; lastSeen: string }>;\n};\n\nexport const useCollaborationStore = defineStore(STORES.COLLABORATION, () => {\n\tconst pushStore = usePushConnectionStore();\n\tconst workflowStore = useWorkflowsStore();\n\n\tconst usersForWorkflows = ref<ActiveUsersForWorkflows>({});\n\tconst pushStoreEventListenerRemovalFn = ref<(() => void) | null>(null);\n\n\tconst getUsersForCurrentWorkflow = computed(() => {\n\t\treturn usersForWorkflows.value[workflowStore.workflowId] ?? [];\n\t});\n\n\tfunction initialize() {\n\t\tpushStoreEventListenerRemovalFn.value = pushStore.addEventListener((event) => {\n\t\t\tif (event.type === 'activeWorkflowUsersChanged') {\n\t\t\t\tconst activeWorkflowId = workflowStore.workflowId;\n\t\t\t\tif (event.data.workflowId === activeWorkflowId) {\n\t\t\t\t\tusersForWorkflows.value[activeWorkflowId] = event.data.activeUsers;\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t}\n\n\tfunction terminate() {\n\t\tif (typeof pushStoreEventListenerRemovalFn.value === 'function') {\n\t\t\tpushStoreEventListenerRemovalFn.value();\n\t\t}\n\t}\n\n\tfunction workflowUsersUpdated(data: ActiveUsersForWorkflows) {\n\t\tusersForWorkflows.value = data;\n\t}\n\n\tfunction notifyWorkflowOpened(workflowId: string) {\n\t\tpushStore.send({\n\t\t\ttype: 'workflowOpened',\n\t\t\tworkflowId,\n\t\t});\n\t}\n\n\tfunction notifyWorkflowClosed(workflowId: string) {\n\t\tpushStore.send({ type: 'workflowClosed', workflowId });\n\t}\n\n\treturn {\n\t\tusersForWorkflows,\n\t\tinitialize,\n\t\tterminate,\n\t\tnotifyWorkflowOpened,\n\t\tnotifyWorkflowClosed,\n\t\tworkflowUsersUpdated,\n\t\tgetUsersForCurrentWorkflow,\n\t};\n});\n"],"names":["usePushConnectionStore","defineStore","STORES","rootStore","useRootStore","settingsStore","useSettingsStore","pushRef","computed","pushSource","ref","reconnectTimeout","connectRetries","lostConnection","outgoingQueue","isConnectionOpen","onMessageReceivedHandlers","addEventListener","handler","index","onConnectionError","pushDisconnect","attemptReconnect","TIME","pushMessageReceived","pushConnect","useWebSockets","restUrl","url","protocol","host","baseUrl","onConnectionSuccess","serializeAndSend","message","_a","send","event","receivedData","useCollaborationStore","pushStore","workflowStore","useWorkflowsStore","usersForWorkflows","pushStoreEventListenerRemovalFn","getUsersForCurrentWorkflow","initialize","activeWorkflowId","terminate","workflowUsersUpdated","data","notifyWorkflowOpened","workflowId","notifyWorkflowClosed"],"mappings":"4JAwBO,MAAMA,EAAyBC,EAAYC,EAAO,KAAM,IAAM,CACpE,MAAMC,EAAYC,IACZC,EAAgBC,IAEhBC,EAAUC,EAAS,IAAML,EAAU,OAAO,EAC1CM,EAAaC,EAAoC,IAAI,EACrDC,EAAmBD,EAA2B,IAAI,EAClDE,EAAiBF,EAAI,CAAC,EACtBG,EAAiBH,EAAI,EAAK,EAC1BI,EAAgBJ,EAAe,CAAA,CAAE,EACjCK,EAAmBL,EAAI,EAAK,EAE5BM,EAA4BN,EAA4B,CAAA,CAAE,EAE1DO,EAAoBC,IACCF,EAAA,MAAM,KAAKE,CAAO,EACrC,IAAM,CACZ,MAAMC,EAAQH,EAA0B,MAAM,QAAQE,CAAO,EACzDC,IAAU,IACaH,EAAA,MAAM,OAAOG,EAAO,CAAC,CAChD,GAIF,SAASC,GAAoB,CACbC,IACAT,EAAA,QACfD,EAAiB,MAAQ,WACxBW,EACA,KAAK,IAAIV,EAAe,MAAQ,IAAM,EAAIW,EAAK,MAAM,CAAA,CAEvD,CAKA,SAASF,GAAiB,CACrBZ,EAAW,QAAU,OACbA,EAAA,MAAM,oBAAoB,QAASW,CAAiB,EACpDX,EAAA,MAAM,oBAAoB,QAASW,CAAiB,EACpDX,EAAA,MAAM,oBAAoB,UAAWe,CAAmB,EAC/Df,EAAW,MAAM,WAAa,GAAGA,EAAW,MAAM,QACtDA,EAAW,MAAQ,MAGpBM,EAAiB,MAAQ,EAC1B,CAKA,SAASU,GAAc,CAEPJ,IAEXV,EAAiB,QACpB,aAAaA,EAAiB,KAAK,EACnCA,EAAiB,MAAQ,MAGpB,MAAAe,EAAgBrB,EAAc,cAAgB,YAE9CsB,EAAUxB,EAAU,QACpByB,EAAM,iBAAiBrB,EAAQ,KAAK,GAE1C,GAAImB,EAAe,CAClB,KAAM,CAAE,SAAAG,EAAU,KAAAC,GAAS,OAAO,SAC5BC,EAAUJ,EAAQ,WAAW,MAAM,EACtCA,EAAQ,QAAQ,QAAS,IAAI,EAC7B,GAAGE,IAAa,SAAW,MAAQ,IAAI,MAAMC,EAAOH,CAAO,GAC9DlB,EAAW,MAAQ,IAAI,UAAU,GAAGsB,CAAO,GAAGH,CAAG,EAAE,CAAA,MAExCnB,EAAA,MAAQ,IAAI,YAAY,GAAGkB,CAAO,GAAGC,CAAG,GAAI,CAAE,gBAAiB,EAAM,CAAA,EAGjFnB,EAAW,MAAM,iBAAiB,OAAQuB,EAAqB,EAAK,EACpEvB,EAAW,MAAM,iBAAiB,UAAWe,EAAqB,EAAK,EACvEf,EAAW,MAAM,iBAAiBiB,EAAgB,QAAU,QAASN,EAAmB,EAAK,CAC9F,CAEA,SAASE,GAAmB,CACfG,GACb,CAEA,SAASQ,EAAiBC,EAAkB,CACvCzB,EAAW,OAAS,SAAUA,EAAW,OAC5CA,EAAW,MAAM,KAAK,KAAK,UAAUyB,CAAO,CAAC,CAE/C,CAEA,SAASF,GAAsB,OAO1B,GANJjB,EAAiB,MAAQ,GACzBH,EAAe,MAAQ,EACvBC,EAAe,MAAQ,GACvBV,EAAU,wBAAwB,GACvBgC,EAAA1B,EAAA,QAAA,MAAA0B,EAAO,oBAAoB,OAAQH,GAE1ClB,EAAc,MAAM,OAAQ,CACpB,UAAAoB,KAAWpB,EAAc,MACnCmB,EAAiBC,CAAO,EAEzBpB,EAAc,MAAQ,EACvB,CACD,CAEA,SAASsB,EAAKF,EAAkB,CAC3B,GAAA,CAACnB,EAAiB,MAAO,CACdD,EAAA,MAAM,KAAKoB,CAAO,EAChC,MACD,CACAD,EAAiBC,CAAO,CACzB,CAKA,eAAeV,EAAoBa,EAAc,CAC5C,IAAAC,EACA,GAAA,CAEYA,EAAA,KAAK,MAAMD,EAAM,IAAI,OACrB,CACf,MACD,CAEArB,EAA0B,MAAM,QAASE,GAAYA,EAAQoB,CAAY,CAAC,CAC3E,CAEO,MAAA,CACN,QAAA/B,EACA,WAAAE,EACA,iBAAAM,EACA,0BAAAC,EACA,iBAAAC,EACA,YAAAQ,EACA,eAAAJ,EACA,KAAAe,CAAA,CAEF,CAAC,ECvJYG,EAAwBtC,EAAYC,EAAO,cAAe,IAAM,CAC5E,MAAMsC,EAAYxC,IACZyC,EAAgBC,IAEhBC,EAAoBjC,EAA6B,CAAA,CAAE,EACnDkC,EAAkClC,EAAyB,IAAI,EAE/DmC,EAA6BrC,EAAS,IACpCmC,EAAkB,MAAMF,EAAc,UAAU,GAAK,CAAA,CAC5D,EAED,SAASK,GAAa,CACrBF,EAAgC,MAAQJ,EAAU,iBAAkBH,GAAU,CACzE,GAAAA,EAAM,OAAS,6BAA8B,CAChD,MAAMU,EAAmBN,EAAc,WACnCJ,EAAM,KAAK,aAAeU,IAC7BJ,EAAkB,MAAMI,CAAgB,EAAIV,EAAM,KAAK,YAEzD,CAAA,CACA,CACF,CAEA,SAASW,GAAY,CAChB,OAAOJ,EAAgC,OAAU,YACpDA,EAAgC,MAAM,CAExC,CAEA,SAASK,EAAqBC,EAA+B,CAC5DP,EAAkB,MAAQO,CAC3B,CAEA,SAASC,EAAqBC,EAAoB,CACjDZ,EAAU,KAAK,CACd,KAAM,iBACN,WAAAY,CAAA,CACA,CACF,CAEA,SAASC,EAAqBD,EAAoB,CACjDZ,EAAU,KAAK,CAAE,KAAM,iBAAkB,WAAAY,CAAY,CAAA,CACtD,CAEO,MAAA,CACN,kBAAAT,EACA,WAAAG,EACA,UAAAE,EACA,qBAAAG,EACA,qBAAAE,EACA,qBAAAJ,EACA,2BAAAJ,CAAA,CAEF,CAAC"}