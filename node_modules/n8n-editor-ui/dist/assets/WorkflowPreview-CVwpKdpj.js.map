{"version":3,"file":"WorkflowPreview-CVwpKdpj.js","sources":["../../src/components/WorkflowPreview.vue"],"sourcesContent":["<template>\n\t<div :class=\"$style.container\">\n\t\t<div v-if=\"loaderType === 'image' && !showPreview\" :class=\"$style.imageLoader\">\n\t\t\t<n8n-loading :loading=\"!showPreview\" :rows=\"1\" variant=\"image\" />\n\t\t</div>\n\t\t<div v-else-if=\"loaderType === 'spinner' && !showPreview\" :class=\"$style.spinner\">\n\t\t\t<n8n-spinner type=\"dots\" />\n\t\t</div>\n\t\t<iframe\n\t\t\tref=\"iframeRef\"\n\t\t\t:class=\"{\n\t\t\t\t[$style.workflow]: !nodeViewDetailsOpened,\n\t\t\t\t[$style.executionPreview]: mode === 'execution',\n\t\t\t\t[$style.openNDV]: nodeViewDetailsOpened,\n\t\t\t\t[$style.show]: showPreview,\n\t\t\t}\"\n\t\t\t:src=\"iframeSrc\"\n\t\t\tdata-test-id=\"workflow-preview-iframe\"\n\t\t\t@mouseenter=\"onMouseEnter\"\n\t\t\t@mouseleave=\"onMouseLeave\"\n\t\t/>\n\t</div>\n</template>\n\n<script setup lang=\"ts\">\nimport { onMounted, onBeforeUnmount, ref, computed, watch } from 'vue';\nimport { useI18n } from '@/composables/useI18n';\nimport { useToast } from '@/composables/useToast';\nimport type { IWorkflowDb, IWorkflowTemplate } from '@/Interface';\nimport { useExecutionsStore } from '@/stores/executions.store';\n\nconst props = withDefaults(\n\tdefineProps<{\n\t\tloading?: boolean;\n\t\tmode?: 'workflow' | 'execution';\n\t\tworkflow?: IWorkflowDb | IWorkflowTemplate['workflow'];\n\t\texecutionId?: string;\n\t\texecutionMode?: string;\n\t\tloaderType?: 'image' | 'spinner';\n\t\tcanOpenNDV?: boolean;\n\t\thideNodeIssues?: boolean;\n\t}>(),\n\t{\n\t\tloading: false,\n\t\tmode: 'workflow',\n\t\tworkflow: undefined,\n\t\texecutionId: undefined,\n\t\texecutionMode: undefined,\n\t\tloaderType: 'image',\n\t\tcanOpenNDV: true,\n\t\thideNodeIssues: false,\n\t},\n);\n\nconst emit = defineEmits<{\n\t(event: 'close'): void;\n}>();\n\nconst i18n = useI18n();\nconst toast = useToast();\nconst executionsStore = useExecutionsStore();\n\nconst iframeRef = ref<HTMLIFrameElement | null>(null);\nconst nodeViewDetailsOpened = ref(false);\nconst ready = ref(false);\nconst insideIframe = ref(false);\nconst scrollX = ref(0);\nconst scrollY = ref(0);\n\nconst iframeSrc = computed(() => {\n\treturn `${window.BASE_PATH ?? '/'}workflows/demo`;\n});\n\nconst showPreview = computed(() => {\n\treturn (\n\t\t!props.loading &&\n\t\t((props.mode === 'workflow' && !!props.workflow) ||\n\t\t\t(props.mode === 'execution' && !!props.executionId)) &&\n\t\tready.value\n\t);\n});\n\nconst loadWorkflow = () => {\n\ttry {\n\t\tif (!props.workflow) {\n\t\t\tthrow new Error(i18n.baseText('workflowPreview.showError.missingWorkflow'));\n\t\t}\n\t\tif (!props.workflow.nodes || !Array.isArray(props.workflow.nodes)) {\n\t\t\tthrow new Error(i18n.baseText('workflowPreview.showError.arrayEmpty'));\n\t\t}\n\t\tiframeRef.value?.contentWindow?.postMessage?.(\n\t\t\tJSON.stringify({\n\t\t\t\tcommand: 'openWorkflow',\n\t\t\t\tworkflow: props.workflow,\n\t\t\t\tcanOpenNDV: props.canOpenNDV,\n\t\t\t\thideNodeIssues: props.hideNodeIssues,\n\t\t\t}),\n\t\t\t'*',\n\t\t);\n\t} catch (error) {\n\t\ttoast.showError(\n\t\t\terror,\n\t\t\ti18n.baseText('workflowPreview.showError.previewError.title'),\n\t\t\ti18n.baseText('workflowPreview.showError.previewError.message'),\n\t\t);\n\t}\n};\n\nconst loadExecution = () => {\n\ttry {\n\t\tif (!props.executionId) {\n\t\t\tthrow new Error(i18n.baseText('workflowPreview.showError.missingExecution'));\n\t\t}\n\t\tiframeRef.value?.contentWindow?.postMessage?.(\n\t\t\tJSON.stringify({\n\t\t\t\tcommand: 'openExecution',\n\t\t\t\texecutionId: props.executionId,\n\t\t\t\texecutionMode: props.executionMode ?? '',\n\t\t\t\tcanOpenNDV: props.canOpenNDV,\n\t\t\t}),\n\t\t\t'*',\n\t\t);\n\n\t\tif (executionsStore.activeExecution) {\n\t\t\tiframeRef.value?.contentWindow?.postMessage?.(\n\t\t\t\tJSON.stringify({\n\t\t\t\t\tcommand: 'setActiveExecution',\n\t\t\t\t\texecutionId: executionsStore.activeExecution.id,\n\t\t\t\t}),\n\t\t\t\t'*',\n\t\t\t);\n\t\t}\n\t} catch (error) {\n\t\ttoast.showError(\n\t\t\terror,\n\t\t\ti18n.baseText('workflowPreview.showError.previewError.title'),\n\t\t\ti18n.baseText('workflowPreview.executionMode.showError.previewError.message'),\n\t\t);\n\t}\n};\n\nconst onMouseEnter = () => {\n\tinsideIframe.value = true;\n\tscrollX.value = window.scrollX;\n\tscrollY.value = window.scrollY;\n};\nconst onMouseLeave = () => {\n\tinsideIframe.value = false;\n};\n\nconst receiveMessage = ({ data }: MessageEvent) => {\n\tif (!data?.includes?.('\"command\"')) {\n\t\treturn;\n\t}\n\ttry {\n\t\tconst json = JSON.parse(data);\n\t\tif (json.command === 'n8nReady') {\n\t\t\tready.value = true;\n\t\t} else if (json.command === 'openNDV') {\n\t\t\tnodeViewDetailsOpened.value = true;\n\t\t} else if (json.command === 'closeNDV') {\n\t\t\tnodeViewDetailsOpened.value = false;\n\t\t} else if (json.command === 'error') {\n\t\t\temit('close');\n\t\t}\n\t} catch (e) {\n\t\tconsole.error(e);\n\t}\n};\nconst onDocumentScroll = () => {\n\tif (insideIframe.value) {\n\t\twindow.scrollTo(scrollX.value, scrollY.value);\n\t}\n};\n\nonMounted(() => {\n\twindow.addEventListener('message', receiveMessage);\n\tdocument.addEventListener('scroll', onDocumentScroll);\n});\n\nonBeforeUnmount(() => {\n\twindow.removeEventListener('message', receiveMessage);\n\tdocument.removeEventListener('scroll', onDocumentScroll);\n});\n\nwatch(\n\t() => showPreview.value,\n\t() => {\n\t\tif (showPreview.value) {\n\t\t\tif (props.mode === 'workflow') {\n\t\t\t\tloadWorkflow();\n\t\t\t} else if (props.mode === 'execution') {\n\t\t\t\tloadExecution();\n\t\t\t}\n\t\t}\n\t},\n);\n\nwatch(\n\t() => props.executionId,\n\t() => {\n\t\tif (props.mode === 'execution' && props.executionId) {\n\t\t\tloadExecution();\n\t\t}\n\t},\n);\n\nwatch(\n\t() => props.workflow,\n\t() => {\n\t\tif (props.mode === 'workflow' && props.workflow) {\n\t\t\tloadWorkflow();\n\t\t}\n\t},\n);\n</script>\n\n<style lang=\"scss\" module>\n.container {\n\twidth: 100%;\n\theight: 100%;\n\tdisplay: flex;\n\tjustify-content: center;\n}\n\n.workflow {\n\t// firefox bug requires loading iframe as such\n\tvisibility: hidden;\n\theight: 0;\n\twidth: 0;\n}\n\n.show {\n\tvisibility: visible;\n\theight: 100%;\n\twidth: 100%;\n}\n\n.openNDV {\n\tposition: fixed;\n\ttop: 0;\n\tleft: 0;\n\theight: 100%;\n\twidth: 100%;\n\tz-index: 9999999;\n}\n\n.spinner {\n\tcolor: var(--color-primary);\n\tposition: absolute;\n\ttop: 50% !important;\n\t-ms-transform: translateY(-50%);\n\ttransform: translateY(-50%);\n}\n\n.imageLoader {\n\twidth: 100%;\n\tdisplay: flex;\n\tjustify-content: center;\n\talign-items: center;\n\theight: 100%;\n}\n\n.executionPreview {\n\theight: 100%;\n}\n</style>\n"],"names":["props","__props","emit","__emit","i18n","useI18n","toast","useToast","executionsStore","useExecutionsStore","iframeRef","ref","nodeViewDetailsOpened","ready","insideIframe","scrollX","scrollY","iframeSrc","computed","showPreview","loadWorkflow","_c","_b","_a","error","loadExecution","_f","_e","_d","onMouseEnter","onMouseLeave","receiveMessage","data","json","e","onDocumentScroll","onMounted","onBeforeUnmount","watch"],"mappings":"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"}