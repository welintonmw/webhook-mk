"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.validLicenseWithUserQuota = exports.validCursor = exports.projectScope = exports.globalScope = void 0;
const typedi_1 = require("typedi");
const License_1 = require("../../../../License");
const pagination_service_1 = require("../services/pagination.service");
const checkAccess_1 = require("../../../../permissions/checkAccess");
const UNLIMITED_USERS_QUOTA = -1;
const buildScopeMiddleware = (scopes, resource, { globalOnly } = { globalOnly: false }) => {
    return async (req, res, next) => {
        const params = {};
        if (req.params.id) {
            if (resource === 'workflow') {
                params.workflowId = req.params.id;
            }
            else if (resource === 'credential') {
                params.credentialId = req.params.id;
            }
        }
        if (!(await (0, checkAccess_1.userHasScope)(req.user, scopes, globalOnly, params))) {
            return res.status(403).json({ message: 'Forbidden' });
        }
        return next();
    };
};
const globalScope = (scopes) => buildScopeMiddleware(Array.isArray(scopes) ? scopes : [scopes], undefined, { globalOnly: true });
exports.globalScope = globalScope;
const projectScope = (scopes, resource) => buildScopeMiddleware(Array.isArray(scopes) ? scopes : [scopes], resource, { globalOnly: false });
exports.projectScope = projectScope;
const validCursor = (req, res, next) => {
    if (req.query.cursor) {
        const { cursor } = req.query;
        try {
            const paginationData = (0, pagination_service_1.decodeCursor)(cursor);
            if ('offset' in paginationData) {
                req.query.offset = paginationData.offset;
                req.query.limit = paginationData.limit;
            }
            else {
                req.query.lastId = paginationData.lastId;
                req.query.limit = paginationData.limit;
            }
        }
        catch (error) {
            return res.status(400).json({
                message: 'An invalid cursor was provided',
            });
        }
    }
    return next();
};
exports.validCursor = validCursor;
const validLicenseWithUserQuota = (_, res, next) => {
    const license = typedi_1.Container.get(License_1.License);
    if (license.getUsersLimit() !== UNLIMITED_USERS_QUOTA) {
        return res.status(403).json({
            message: '/users path can only be used with a valid license. See https://n8n.io/pricing/',
        });
    }
    return next();
};
exports.validLicenseWithUserQuota = validLicenseWithUserQuota;
//# sourceMappingURL=global.middleware.js.map